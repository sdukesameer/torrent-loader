<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Torrent Loader</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link
      href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Syne:wght@400;700;800&display=swap"
      rel="stylesheet">
    <style>
      :root {
        --bg: #0a0a0f;
        --surface: #12121a;
        --surface2: #1a1a26;
        --border: #2a2a3d;
        --accent: #00e5ff;
        --accent2: #7c3aed;
        --green: #00ff87;
        --red: #ff4060;
        --yellow: #ffd700;
        --text: #e8e8f0;
        --muted: #6b6b8a;
        --font-mono: 'Space Mono', monospace;
        --font-display: 'Syne', sans-serif;
      }

      *,
      *::before,
      *::after {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        background: var(--bg);
        color: var(--text);
        font-family: var(--font-mono);
        min-height: 100vh;
        overflow-x: hidden;
      }

      body::before {
        content: '';
        position: fixed;
        inset: 0;
        pointer-events: none;
        z-index: 0;
        background-image: linear-gradient(rgba(0, 229, 255, .03) 1px, transparent 1px), linear-gradient(90deg, rgba(0, 229, 255, .03) 1px, transparent 1px);
        background-size: 40px 40px;
      }

      .container {
        max-width: 900px;
        margin: 0 auto;
        padding: 40px 24px;
        position: relative;
        z-index: 1;
      }

      header {
        margin-bottom: 48px;
      }

      .logo-row {
        display: flex;
        align-items: center;
        gap: 16px;
        margin-bottom: 8px;
      }

      .logo-icon {
        width: 44px;
        height: 44px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 22px;
        flex-shrink: 0;
        background: linear-gradient(135deg, var(--accent2), var(--accent));
        box-shadow: 0 0 24px rgba(0, 229, 255, .3);
      }

      h1 {
        font-family: var(--font-display);
        font-size: clamp(1.6rem, 4vw, 2.4rem);
        font-weight: 800;
        letter-spacing: -.5px;
        background: linear-gradient(135deg, #fff 40%, var(--accent));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .subtitle {
        color: var(--muted);
        font-size: .78rem;
        letter-spacing: .08em;
        text-transform: uppercase;
      }

      .card {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 14px;
        padding: 28px;
        margin-bottom: 24px;
        position: relative;
        overflow: hidden;
      }

      .card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 1px;
        opacity: .5;
        background: linear-gradient(90deg, transparent, var(--accent), transparent);
      }

      .card-title {
        font-family: var(--font-display);
        font-size: .7rem;
        font-weight: 700;
        letter-spacing: .15em;
        text-transform: uppercase;
        color: var(--accent);
        margin-bottom: 18px;
      }

      .input-group {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
      }

      textarea {
        flex: 1;
        min-width: 200px;
        background: var(--surface2);
        border: 1px solid var(--border);
        border-radius: 8px;
        color: var(--text);
        font-family: var(--font-mono);
        font-size: .78rem;
        padding: 14px 16px;
        resize: vertical;
        min-height: 80px;
        transition: border-color .2s;
        outline: none;
      }

      textarea::placeholder {
        color: var(--muted);
      }

      textarea:focus {
        border-color: var(--accent);
        box-shadow: 0 0 0 2px rgba(0, 229, 255, .1);
      }

      .btn {
        background: linear-gradient(135deg, var(--accent2), #4f46e5);
        color: #fff;
        border: none;
        border-radius: 8px;
        padding: 14px 24px;
        font-family: var(--font-display);
        font-weight: 700;
        font-size: .85rem;
        cursor: pointer;
        transition: all .2s;
        white-space: nowrap;
        align-self: flex-end;
        letter-spacing: .03em;
      }

      .btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 20px rgba(124, 58, 237, .5);
      }

      .btn:active {
        transform: translateY(0);
      }

      .btn:disabled {
        opacity: .5;
        cursor: not-allowed;
        transform: none;
      }

      .btn-sm {
        padding: 6px 12px;
        font-size: .7rem;
        border-radius: 6px;
      }

      .btn-danger {
        background: linear-gradient(135deg, #7f1d1d, var(--red));
      }

      .btn-ghost {
        background: transparent;
        border: 1px solid var(--border);
        color: var(--muted);
      }

      .btn-ghost:hover {
        background: var(--surface2);
        color: var(--text);
        box-shadow: none;
      }

      #statusMsg {
        font-size: .78rem;
        padding: 10px 14px;
        border-radius: 6px;
        margin-top: 14px;
        display: none;
      }

      #statusMsg.success {
        background: rgba(0, 255, 135, .1);
        border: 1px solid rgba(0, 255, 135, .3);
        color: var(--green);
        display: block;
      }

      #statusMsg.error {
        background: rgba(255, 64, 96, .1);
        border: 1px solid rgba(255, 64, 96, .3);
        color: var(--red);
        display: block;
      }

      .torrent-item {
        background: var(--surface2);
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 18px 20px;
        margin-bottom: 14px;
        transition: border-color .2s;
        animation: slideIn .3s ease;
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(-8px);
        }

        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .torrent-item:hover {
        border-color: rgba(0, 229, 255, .3);
      }

      .torrent-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 12px;
        margin-bottom: 12px;
        flex-wrap: wrap;
      }

      .torrent-name {
        font-family: var(--font-display);
        font-weight: 700;
        font-size: .92rem;
        color: var(--text);
        word-break: break-word;
        flex: 1;
      }

      .torrent-actions {
        display: flex;
        gap: 8px;
        flex-shrink: 0;
      }

      .progress-wrap {
        background: var(--surface);
        border-radius: 4px;
        height: 6px;
        overflow: hidden;
        margin-bottom: 10px;
      }

      .progress-bar {
        height: 100%;
        border-radius: 4px;
        background: linear-gradient(90deg, var(--accent2), var(--accent));
        transition: width 1s linear;
        position: relative;
      }

      .progress-bar.done {
        background: linear-gradient(90deg, #00b359, var(--green));
      }

      .progress-bar::after {
        content: '';
        position: absolute;
        right: 0;
        top: 0;
        bottom: 0;
        width: 20px;
        background: rgba(255, 255, 255, .3);
        filter: blur(4px);
      }

      .torrent-meta {
        display: flex;
        gap: 20px;
        flex-wrap: wrap;
        font-size: .72rem;
        color: var(--muted);
      }

      .meta-item {
        display: flex;
        align-items: center;
        gap: 5px;
      }

      .meta-item .val {
        color: var(--text);
        font-weight: 700;
      }

      .badge {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 20px;
        font-size: .65rem;
        font-weight: 700;
        letter-spacing: .05em;
        text-transform: uppercase;
      }

      .badge-dl {
        background: rgba(0, 229, 255, .12);
        color: var(--accent);
        border: 1px solid rgba(0, 229, 255, .3);
      }

      .badge-seed {
        background: rgba(0, 255, 135, .12);
        color: var(--green);
        border: 1px solid rgba(0, 255, 135, .3);
      }

      .badge-pause {
        background: rgba(255, 215, 0, .12);
        color: var(--yellow);
        border: 1px solid rgba(255, 215, 0, .3);
      }

      .badge-meta {
        background: rgba(124, 58, 237, .12);
        color: #a78bfa;
        border: 1px solid rgba(124, 58, 237, .3);
      }

      .badge-err {
        background: rgba(255, 64, 96, .12);
        color: var(--red);
        border: 1px solid rgba(255, 64, 96, .3);
      }

      .files-toggle {
        font-size: .7rem;
        color: var(--muted);
        cursor: pointer;
        margin-top: 10px;
        display: inline-flex;
        align-items: center;
        gap: 5px;
        transition: color .2s;
      }

      .files-toggle:hover {
        color: var(--accent);
      }

      .files-list {
        margin-top: 10px;
        display: none;
        flex-direction: column;
        gap: 6px;
      }

      .files-list.open {
        display: flex;
      }

      .file-entry {
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: var(--surface);
        border-radius: 6px;
        padding: 8px 12px;
        font-size: .72rem;
        gap: 10px;
        flex-wrap: wrap;
      }

      .file-entry a {
        color: var(--accent);
        text-decoration: none;
        font-size: .68rem;
        border: 1px solid rgba(0, 229, 255, .3);
        padding: 3px 8px;
        border-radius: 4px;
        transition: all .2s;
      }

      .file-entry a:hover {
        background: rgba(0, 229, 255, .1);
      }

      .file-name {
        color: var(--text);
        word-break: break-all;
        flex: 1;
      }

      .file-size {
        color: var(--muted);
        flex-shrink: 0;
      }

      .empty-state {
        text-align: center;
        padding: 48px 24px;
        color: var(--muted);
      }

      .empty-state .icon {
        font-size: 3rem;
        margin-bottom: 14px;
        opacity: .4;
      }

      .empty-state p {
        font-size: .82rem;
      }

      .stats-bar {
        display: flex;
        gap: 24px;
        padding: 16px 0;
        border-bottom: 1px solid var(--border);
        margin-bottom: 20px;
        flex-wrap: wrap;
      }

      .stat {
        font-size: .72rem;
      }

      .stat-label {
        color: var(--muted);
      }

      .stat-val {
        color: var(--accent);
        font-weight: 700;
      }

      footer {
        text-align: center;
        color: var(--muted);
        font-size: .68rem;
        margin-top: 48px;
        letter-spacing: .08em;
      }

      footer a {
        color: var(--accent);
        text-decoration: none;
      }

      ::-webkit-scrollbar {
        width: 6px;
      }

      ::-webkit-scrollbar-track {
        background: var(--surface);
      }

      ::-webkit-scrollbar-thumb {
        background: var(--border);
        border-radius: 3px;
      }

    </style>
  </head>

  <body>
    <div class="container">
      <header>
        <div class="logo-row">
          <div class="logo-icon">‚¨á</div>
          <div>
            <h1>Torrent Loader</h1>
            <div class="subtitle">Personal Web Torrent Client</div>
          </div>
        </div>
      </header>

      <div class="card">
        <div class="card-title">‚ñ∏ Add Magnet Link</div>
        <div class="input-group">
          <textarea id="magnetInput" placeholder="Paste magnet link here‚Ä¶ magnet:?xt=urn:btih:‚Ä¶"></textarea>
          <button class="btn" id="addBtn" onclick="addTorrent()">Add Torrent</button>
        </div>
        <div id="statusMsg"></div>
      </div>

      <div class="card">
        <div class="card-title">‚ñ∏ Active Downloads</div>
        <div class="stats-bar" id="statsBar" style="display:none">
          <div class="stat"><span class="stat-label">Total ‚Üì </span><span class="stat-val" id="totalDown">0 B/s</span>
          </div>
          <div class="stat"><span class="stat-label">Total ‚Üë </span><span class="stat-val" id="totalUp">0 B/s</span>
          </div>
          <div class="stat"><span class="stat-label">Torrents </span><span class="stat-val" id="totalCount">0</span>
          </div>
        </div>
        <div id="torrentList">
          <div class="empty-state">
            <div class="icon">üì°</div>
            <p>No active torrents. Paste a magnet link above to get started.</p>
          </div>
        </div>
      </div>

      <footer>Torrent Loader ¬∑ Personal Use Only ¬∑ <a href="https://github.com/arvidn/libtorrent"
          target="_blank">Powered by libtorrent</a></footer>
    </div>

    <script>
      var uiState = {};  // tid -> { filesOpen }
      var data = [];

      function fmt(b) {
        if (b < 1024) return b + ' B';
        if (b < 1048576) return (b / 1024).toFixed(1) + ' KB';
        if (b < 1073741824) return (b / 1048576).toFixed(1) + ' MB';
        return (b / 1073741824).toFixed(2) + ' GB';
      }
      function fmtSpeed(b) { return fmt(b) + '/s'; }

      function badge(state, paused, prog) {
        if (paused) return '<span class="badge badge-pause">Paused</span>';
        var s = (state || '').toLowerCase();
        if (s === 'adding') return '<span class="badge badge-meta">Adding‚Ä¶</span>';
        if (prog >= 100) return '<span class="badge badge-seed">Seeding ‚úì</span>';
        if (s.indexOf('check') >= 0) return '<span class="badge badge-meta">Checking</span>';
        if (s.indexOf('metadata') >= 0 || s === 'downloading_metadata') return '<span class="badge badge-meta">Fetching Metadata</span>';
        if (s === 'downloading' || s.indexOf('download') >= 0) return '<span class="badge badge-dl">Downloading</span>';
        if (s === 'seeding' || s.indexOf('seed') >= 0) return '<span class="badge badge-seed">Seeding ‚úì</span>';
        if (s.indexOf('error') >= 0) return '<span class="badge badge-err">Error</span>';
        return '<span class="badge badge-meta">' + esc(state) + '</span>';
      }

      function esc(s) {
        return String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
      }

      function renderTorrent(t) {
        var prog = Math.min(t.progress || 0, 100);
        var done = prog >= 100;
        var tid = t.id;
        var open = uiState[tid] && uiState[tid].filesOpen;

        var filesHtml = '';
        if (t.files && t.files.length > 0) {
          var label = open ? 'hide' : 'show';
          var fileRows = '';
          for (var i = 0; i < t.files.length; i++) {
            var f = t.files[i];
            var dl = done ? '<a href="/api/download/' + tid + '/' + encodeURIComponent(f.path) + '">‚Üì Download</a>' : '';
            fileRows += '<div class="file-entry"><span class="file-name">' + esc(f.path) + '</span><span class="file-size">' + fmt(f.size) + '</span>' + dl + '</div>';
          }
          filesHtml = '<div class="files-toggle" onclick="toggleFiles(\'' + tid + '\')">üìÅ ' + t.files.length + ' file' + (t.files.length > 1 ? 's' : '') + ' ‚Äî click to ' + label + '</div>'
            + '<div class="files-list' + (open ? ' open' : '') + '" id="files-' + tid + '">' + fileRows + '</div>';
        }

        var pauseBtn = t.paused
          ? '<button class="btn btn-sm btn-ghost" onclick="resumeTorrent(\'' + tid + '\')">‚ñ∂ Resume</button>'
          : '<button class="btn btn-sm btn-ghost" onclick="pauseTorrent(\'' + tid + '\')">‚è∏ Pause</button>';

        var sizeHtml = t.total_wanted > 0 ? '<div class="meta-item"><span>Size</span><span class="val">' + fmt(t.total_wanted) + '</span></div>' : '';

        return '<div class="torrent-item" id="item-' + tid + '">'
          + '<div class="torrent-header"><div>'
          + '<div class="torrent-name">' + esc(t.name || 'Fetching metadata‚Ä¶') + '</div>'
          + '<div style="margin-top:5px">' + badge(t.state, t.paused, prog) + '</div>'
          + '</div><div class="torrent-actions">' + pauseBtn
          + '<button class="btn btn-sm btn-danger" onclick="removeTorrent(\'' + tid + '\')">‚úï</button>'
          + '</div></div>'
          + '<div class="progress-wrap"><div class="progress-bar' + (done ? ' done' : '') + '" style="width:' + prog + '%"></div></div>'
          + '<div class="torrent-meta">'
          + '<div class="meta-item"><span>Progress</span><span class="val">' + prog.toFixed(1) + '%</span></div>'
          + '<div class="meta-item"><span>‚Üì</span><span class="val">' + fmtSpeed(t.download_rate || 0) + '</span></div>'
          + '<div class="meta-item"><span>‚Üë</span><span class="val">' + fmtSpeed(t.upload_rate || 0) + '</span></div>'
          + '<div class="meta-item"><span>Peers</span><span class="val">' + (t.num_peers || 0) + '</span></div>'
          + sizeHtml + '</div>' + filesHtml + '</div>';
      }

      function toggleFiles(tid) {
        if (!uiState[tid]) uiState[tid] = {};
        uiState[tid].filesOpen = !uiState[tid].filesOpen;
        renderAll();
      }

      function renderAll() {
        var list = document.getElementById('torrentList');
        var statsBar = document.getElementById('statsBar');
        if (!data.length) {
          list.innerHTML = '<div class="empty-state"><div class="icon">üì°</div><p>No active torrents. Paste a magnet link above to get started.</p></div>';
          statsBar.style.display = 'none';
          return;
        }
        statsBar.style.display = 'flex';
        var totalDown = 0, totalUp = 0;
        for (var i = 0; i < data.length; i++) { totalDown += data[i].download_rate || 0; totalUp += data[i].upload_rate || 0; }
        document.getElementById('totalDown').textContent = fmtSpeed(totalDown);
        document.getElementById('totalUp').textContent = fmtSpeed(totalUp);
        document.getElementById('totalCount').textContent = data.length;
        list.innerHTML = data.map(renderTorrent).join('');
      }

      function showStatus(msg, type) {
        var el = document.getElementById('statusMsg');
        el.className = type;
        el.textContent = msg;
        setTimeout(function () { el.className = ''; el.style.display = 'none'; }, 4000);
      }

      function addTorrent() {
        var magnet = document.getElementById('magnetInput').value.trim();
        if (!magnet) { showStatus('Please paste a magnet link.', 'error'); return; }
        var btn = document.getElementById('addBtn');
        btn.disabled = true; btn.textContent = 'Adding‚Ä¶';
        fetch('/api/add', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ magnet: magnet }) })
          .then(function (r) { return r.json(); })
          .then(function (d) {
            if (d.error) { showStatus(d.error, 'error'); }
            else { document.getElementById('magnetInput').value = ''; showStatus('Added: ' + d.name, 'success'); refresh(); }
          })
          .catch(function (e) { showStatus('Request failed: ' + e.message, 'error'); })
          .finally(function () { btn.disabled = false; btn.textContent = 'Add Torrent'; });
      }

      function pauseTorrent(tid) {
        fetch('/api/torrent/' + tid + '/pause', { method: 'POST' }).then(refresh);
      }
      function resumeTorrent(tid) {
        fetch('/api/torrent/' + tid + '/resume', { method: 'POST' }).then(refresh);
      }
      function removeTorrent(tid) {
        if (!confirm('Remove this torrent? Downloaded files will remain on the server.')) return;
        fetch('/api/torrent/' + tid + '/remove', { method: 'DELETE' }).then(function () { delete uiState[tid]; refresh(); });
      }

      function refresh() {
        return fetch('/api/torrents')
          .then(function (r) { return r.json(); })
          .then(function (d) { data = d; renderAll(); })
          .catch(function (e) { console.error('Refresh error:', e); });
      }

      document.getElementById('magnetInput').addEventListener('keydown', function (e) {
        if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); addTorrent(); }
      });

      // Smart polling: 3s when torrents exist, 20s when empty
      function scheduleRefresh() {
        var interval = data.length > 0 ? 3000 : 20000;
        setTimeout(function () { refresh().then(scheduleRefresh); }, interval);
      }

      refresh().then(scheduleRefresh);
    </script>
  </body>

</html>
